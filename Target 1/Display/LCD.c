#include "LCD.h"

static uint8_t current_line = 0;
static uint8_t current_column = 0;

static const uint8_t font5x7[][5] = 
{
  {0x00, 0x00, 0x00, 0x00, 0x00}, // space
	{0x00, 0x00, 0x2f, 0x00, 0x00}, // !
	{0x00, 0x07, 0x00, 0x07, 0x00}, // "
	{0x14, 0x7f, 0x14, 0x7f, 0x14}, // #
	{0x24, 0x2a, 0x7f, 0x2a, 0x12}, // $
	{0x23, 0x13, 0x08, 0x64, 0x62}, // %
	{0x36, 0x49, 0x55, 0x22, 0x50}, // &
	{0x00, 0x05, 0x03, 0x00, 0x00}, // '
	{0x00, 0x1c, 0x22, 0x41, 0x00}, // (
	{0x00, 0x41, 0x22, 0x1c, 0x00}, // )
	{0x14, 0x08, 0x3E, 0x08, 0x14}, // *
	{0x08, 0x08, 0x3E, 0x08, 0x08}, // +
	{0x00, 0x00, 0xA0, 0x60, 0x00}, // ,
	{0x08, 0x08, 0x08, 0x08, 0x08}, // -
	{0x00, 0x60, 0x60, 0x00, 0x00}, // .
	{0x20, 0x10, 0x08, 0x04, 0x02}, // /
	{0x3E, 0x51, 0x49, 0x45, 0x3E}, // 0
	{0x00, 0x42, 0x7F, 0x40, 0x00}, // 1
	{0x42, 0x61, 0x51, 0x49, 0x46}, // 2
	{0x21, 0x41, 0x45, 0x4B, 0x31}, // 3
	{0x18, 0x14, 0x12, 0x7F, 0x10}, // 4
	{0x27, 0x45, 0x45, 0x45, 0x39}, // 5
	{0x3C, 0x4A, 0x49, 0x49, 0x30}, // 6
	{0x01, 0x71, 0x09, 0x05, 0x03}, // 7
	{0x36, 0x49, 0x49, 0x49, 0x36}, // 8
	{0x06, 0x49, 0x49, 0x29, 0x1E}, // 9
	{0x00, 0x36, 0x36, 0x00, 0x00}, // :
	{0x00, 0x56, 0x36, 0x00, 0x00}, // ;
	{0x08, 0x14, 0x22, 0x41, 0x00}, // <
	{0x14, 0x14, 0x14, 0x14, 0x14}, // =
	{0x00, 0x41, 0x22, 0x14, 0x08}, // >
	{0x02, 0x01, 0x51, 0x09, 0x06}, // ?
	{0x32, 0x49, 0x59, 0x51, 0x3E}, // @
	{0x7C, 0x12, 0x11, 0x12, 0x7C}, // A
	{0x7F, 0x49, 0x49, 0x49, 0x36}, // B
	{0x3E, 0x41, 0x41, 0x41, 0x22}, // C
	{0x7F, 0x41, 0x41, 0x22, 0x1C}, // D
	{0x7F, 0x49, 0x49, 0x49, 0x41}, // E
	{0x7F, 0x09, 0x09, 0x09, 0x01}, // F
	{0x3E, 0x41, 0x49, 0x49, 0x7A}, // G
	{0x7F, 0x08, 0x08, 0x08, 0x7F}, // H
	{0x00, 0x41, 0x7F, 0x41, 0x00}, // I
	{0x20, 0x40, 0x41, 0x3F, 0x01}, // J
	{0x7F, 0x08, 0x14, 0x22, 0x41}, // K
	{0x7F, 0x40, 0x40, 0x40, 0x40}, // L
	{0x7F, 0x02, 0x0C, 0x02, 0x7F}, // M
	{0x7F, 0x04, 0x08, 0x10, 0x7F}, // N
	{0x3E, 0x41, 0x41, 0x41, 0x3E}, // O
	{0x7F, 0x09, 0x09, 0x09, 0x06}, // P
	{0x3E, 0x41, 0x51, 0x21, 0x5E}, // Q
	{0x7F, 0x09, 0x19, 0x29, 0x46}, // R
	{0x46, 0x49, 0x49, 0x49, 0x31}, // S
	{0x01, 0x01, 0x7F, 0x01, 0x01}, // T
	{0x3F, 0x40, 0x40, 0x40, 0x3F}, // U
	{0x1F, 0x20, 0x40, 0x20, 0x1F}, // V
	{0x3F, 0x40, 0x38, 0x40, 0x3F}, // W
	{0x63, 0x14, 0x08, 0x14, 0x63}, // X
	{0x07, 0x08, 0x70, 0x08, 0x07}, // Y
	{0x61, 0x51, 0x49, 0x45, 0x43}, // Z
	{0x00, 0x7F, 0x41, 0x41, 0x00}, // [
	{0x55, 0xAA, 0x55, 0xAA, 0x55}, // Backslash (Checker pattern)
	{0x00, 0x41, 0x41, 0x7F, 0x00}, // ]
	{0x04, 0x02, 0x01, 0x02, 0x04}, // ^
	{0x40, 0x40, 0x40, 0x40, 0x40}, // _
	{0x00, 0x03, 0x05, 0x00, 0x00}, // `
	{0x20, 0x54, 0x54, 0x54, 0x78}, // a
	{0x7F, 0x48, 0x44, 0x44, 0x38}, // b
	{0x38, 0x44, 0x44, 0x44, 0x20}, // c
	{0x38, 0x44, 0x44, 0x48, 0x7F}, // d
	{0x38, 0x54, 0x54, 0x54, 0x18}, // e
	{0x08, 0x7E, 0x09, 0x01, 0x02}, // f
	{0x18, 0xA4, 0xA4, 0xA4, 0x7C}, // g
	{0x7F, 0x08, 0x04, 0x04, 0x78}, // h
	{0x00, 0x44, 0x7D, 0x40, 0x00}, // i
	{0x40, 0x80, 0x84, 0x7D, 0x00}, // j
	{0x7F, 0x10, 0x28, 0x44, 0x00}, // k
	{0x00, 0x41, 0x7F, 0x40, 0x00}, // l
	{0x7C, 0x04, 0x18, 0x04, 0x78}, // m
	{0x7C, 0x08, 0x04, 0x04, 0x78}, // n
	{0x38, 0x44, 0x44, 0x44, 0x38}, // o
	{0xFC, 0x24, 0x24, 0x24, 0x18}, // p
	{0x18, 0x24, 0x24, 0x18, 0xFC}, // q
	{0x7C, 0x08, 0x04, 0x04, 0x08}, // r
	{0x48, 0x54, 0x54, 0x54, 0x20}, // s
	{0x04, 0x3F, 0x44, 0x40, 0x20}, // t
	{0x3C, 0x40, 0x40, 0x20, 0x7C}, // u
	{0x1C, 0x20, 0x40, 0x20, 0x1C}, // v
	{0x3C, 0x40, 0x30, 0x40, 0x3C}, // w
	{0x44, 0x28, 0x10, 0x28, 0x44}, // x
	{0x1C, 0xA0, 0xA0, 0xA0, 0x7C}, // y
	{0x44, 0x64, 0x54, 0x4C, 0x44}, // z
	{0x00, 0x10, 0x7C, 0x82, 0x00}, // {
	{0x00, 0x00, 0xFF, 0x00, 0x00}, // |
	{0x00, 0x82, 0x7C, 0x10, 0x00}, // }
	{0x00, 0x06, 0x09, 0x09, 0x06}	// ~ (Degrees)
};

void OLED_Init(void)
{
	OLED_WriteCmd(0xAE); // Display off
	OLED_WriteCmd(0x20); // Set Memory Addressing Mode
	OLED_WriteCmd(0x10); // Page Addressing Mode
	OLED_WriteCmd(0xB0); // Page start
	OLED_WriteCmd(0xC8); // COM Output Scan Direction
	OLED_WriteCmd(0x00); // Low column
	OLED_WriteCmd(0x10); // High column
	OLED_WriteCmd(0x40); // Start line
	OLED_WriteCmd(0x81); // Contrast
	OLED_WriteCmd(0x7F);
	OLED_WriteCmd(0xA1); // Segment re-map
	OLED_WriteCmd(0xA6); // Normal display
	OLED_WriteCmd(0xA8); // Multiplex ratio
	OLED_WriteCmd(0x3F);
	OLED_WriteCmd(0xA4);
	OLED_WriteCmd(0xD3);
	OLED_WriteCmd(0x00);
	OLED_WriteCmd(0xD5);
	OLED_WriteCmd(0xF0);
	OLED_WriteCmd(0xD9);
	OLED_WriteCmd(0x22);
	OLED_WriteCmd(0xDA);
	OLED_WriteCmd(0x12);
	OLED_WriteCmd(0xDB);
	OLED_WriteCmd(0x20);
	OLED_WriteCmd(0x8D);
	OLED_WriteCmd(0x14);
	OLED_WriteCmd(0xAF); // Display ON
}

static void I2C_ResetBus(void) 
{
	I2C_GenerateSTOP(I2C_Channel, ENABLE);
	I2C_SoftwareResetCmd(I2C_Channel, ENABLE);
	for (volatile int i=0; i<1000; i++);  // short delay
	I2C_SoftwareResetCmd(I2C_Channel, DISABLE);
	I2C_Cmd(I2C_Channel, ENABLE);
}

static void I2C_WriteByte(uint8_t control, uint8_t data)
{
	uint32_t timeout = 10000;
	
	while (I2C_GetFlagStatus(I2C1, I2C_FLAG_BUSY))
	{
		if (--timeout == 0) 
		{
			I2C_ResetBus();  // reset if timeout
			return;
		}
	}
	
	/* Send START condition */
	I2C_GenerateSTART(I2C_Channel, ENABLE);
	while (!I2C_CheckEvent(I2C_Channel, I2C_EVENT_MASTER_MODE_SELECT));

	/* Send address for write */
	I2C_Send7bitAddress(I2C_Channel, OLED_Address << 1, I2C_Direction_Transmitter);
	while (!I2C_CheckEvent(I2C_Channel, I2C_EVENT_MASTER_TRANSMITTER_MODE_SELECTED));
	
	I2C_SendData(I2C_Channel, control);
	while (!I2C_CheckEvent(I2C_Channel, I2C_EVENT_MASTER_BYTE_TRANSMITTED));

	/* Send data */
	I2C_SendData(I2C_Channel, data);
	while (!I2C_CheckEvent(I2C_Channel, I2C_EVENT_MASTER_BYTE_TRANSMITTED));

	/* Send STOP condition */
	I2C_GenerateSTOP(I2C_Channel, ENABLE);		
}

void OLED_WriteCmd(uint8_t command)
{
	I2C_WriteByte(0x00, command);
}

void OLED_WriteData(uint8_t data)
{
	I2C_WriteByte(0x40, data);	
}

void OLED_Clear(void)
{
//	OLED_SetCursor(0,0);
	
	for (uint8_t page=0; page<8; page++)
	{
		OLED_WriteCmd(0xB0 + page); // Page address
		OLED_WriteCmd(0x00);        // Lower column
		OLED_WriteCmd(0x10);        // Higher column
		
		for (uint8_t col=0; col<OLED_WIDTH; col++)
		{
				OLED_WriteData(0x00);
		}
	}
}

void OLED_DrawHorizontalLine(void)
{
	OLED_WriteCmd(0xB3); // Page 3
	OLED_WriteCmd(0x00);
	OLED_WriteCmd(0x10);
	
	for (uint8_t i=0; i<128; i++)
	{
			OLED_WriteData(0xFF); // Full pixels
	}	
}

static void OLED_PutChar(char c)
{
	if (c < 32 || c > 127) c = ' '; // char invalid
	
	const uint8_t *bitmap = font5x7[c - 0x20];

	for (uint8_t i=0; i<5; i++)
	{
		OLED_WriteData(bitmap[i]);
	}

	OLED_WriteData(0x00);  // space between characters

//	OLED_X += 6;  // 5 pixels + 1 padding

//	if (OLED_X > 122)
//	{
//		OLED_X = 0;
//		OLED_Y++;
//		OLED_GotoXY(OLED_X, OLED_Y);
//	}
}

void OLED_Puts(char *str)
{
	while (*str) 
	{
		if (*str == '\n') 
		{
			current_line = (current_line + 1) % 8;
			OLED_SetCursor(current_line, 0);
		} 
		else 
		{
			OLED_PutChar(*str);
			current_column += 6;
			
			if (current_column + 5 >= OLED_WIDTH) 
			{
				current_line = (current_line + 1) % 8;
				current_column = 0;
				OLED_SetCursor(current_line, 0);
			}
		}
		str++;
	}
}

void OLED_SetCursor(uint8_t line, uint8_t column)
{
	current_line   = line;
	current_column = column;

	OLED_WriteCmd(0xB0 + current_line);                // Page address
	OLED_WriteCmd(0x00 + (current_column & 0x0F));         // Lower column
	OLED_WriteCmd(0x10 + ((current_column >> 4) & 0x0F));  // Higher column
}

